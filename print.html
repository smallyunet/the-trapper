<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/smallyunet/the-trapper" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-trapper-"><a class="header" href="#the-trapper-">THE TRAPPER ü™§</a></h1>
<blockquote>
<p><strong>STATUS:</strong> üî¥ DANGER // EXPERIMENTAL // DO NOT USE IN PRODUCTION</p>
</blockquote>
<p><strong>The-Trapper</strong> is a collection of <strong>EVM Honeypots</strong> designed for educational purposes and "Defense against the Dark Arts". These smart contracts appear superficially vulnerable to standard exploits (ownership takeover, MEV extraction, reentrancy) but contain hidden mechanisms to trap sophisticated attackers.</p>
<h2 id="-disclaimer"><a class="header" href="#-disclaimer">‚ö†Ô∏è DISCLAIMER</a></h2>
<p><strong>THIS REPOSITORY IS FOR EDUCATIONAL AND RESEARCH PURPOSES ONLY.</strong></p>
<ul>
<li>The code contained herein is intentionally malicious towards attackers.</li>
<li><strong>DO NOT</strong> deploy these contracts to trap innocent users.</li>
<li><strong>DO NOT</strong> use this code to steal funds from legitimate participants.</li>
<li>The authors accept no responsibility for funds lost, locked, or burnt using these patterns.</li>
</ul>
<hr />
<h2 id="-the-arsenal"><a class="header" href="#-the-arsenal">üìÇ The Arsenal</a></h2>
<h3 id="1-storageghost-srctrapsstorageghostsol"><a class="header" href="#1-storageghost-srctrapsstorageghostsol">1. StorageGhost (<code>src/traps/StorageGhost.sol</code>)</a></h3>
<p><strong>The Bait:</strong>
A classic <code>delegatecall</code> vulnerability. The contract allows users to execute arbitrary logic via a delegate call, seemingly allowing an attacker to overwrite the <code>owner</code> variable (often assumed to be at Slot 0) by passing a malicious implementation.</p>
<p><strong>The Trap:</strong>
Uses <strong>Storage Layout Misalignment</strong>. The contract defines a hidden <code>trapSlot</code> at Slot 0. The real <code>owner</code> is stored at a randomized or unstructured slot (using inline assembly).</p>
<ul>
<li><strong>Outcome:</strong> When the attacker tries to write their address to Slot 0 (thinking it's <code>owner</code>), they unknowingly write to <code>trapSlot</code>.</li>
<li><strong>Punishment:</strong> The contract detects <code>trapSlot != 0</code> and enters an infinite loop (consuming all gas) or permanently bricks the contract.</li>
</ul>
<h3 id="2-antimev-srctrapsantimevsol"><a class="header" href="#2-antimev-srctrapsantimevsol">2. AntiMEV (<code>src/traps/AntiMEV.sol</code>)</a></h3>
<p><strong>The Bait:</strong>
An exposed method <code>claimProfit()</code> that looks like a guaranteed arbitrage opportunity or free mint.</p>
<p><strong>The Trap:</strong>
Detects simulation execution environments and aggressive MEV behaviors.</p>
<ul>
<li><strong>Mechanism:</strong> Checks <code>tx.gasprice</code>, <code>gasleft()</code>, and subtle block properties.</li>
<li><strong>Punishment:</strong> If extensive gas or simulation patterns are detected, it performs a "Silent Fail" or a "Gas Bomb" (checking conditions that are true only during real execution vs simulation).</li>
</ul>
<h3 id="3-reentrancybait-srctrapsreentrancybaitsol"><a class="header" href="#3-reentrancybait-srctrapsreentrancybaitsol">3. ReentrancyBait (<code>src/traps/ReentrancyBait.sol</code>)</a></h3>
<p><strong>The Bait:</strong>
Violates the specific Checks-Effects-Interactions pattern, sending ETH before updating balances.</p>
<p><strong>The Trap:</strong>
A hidden reentrancy guard or state corruption trigger.</p>
<ul>
<li><strong>Mechanism:</strong> Uses a shadow variable that is toggled during the call.</li>
<li><strong>Punishment:</strong> Standard reentrancy attacks will succeed in the re-entrant call (opcode level) but fail the overall transaction due to a hidden post-execution check, wasting the attacker's gas for the complex attack transaction.</li>
</ul>
<hr />
<h2 id="-usage"><a class="header" href="#-usage">üõ† Usage</a></h2>
<p>This project uses <a href="https://getfoundry.sh">Foundry</a>.</p>
<h3 id="build"><a class="header" href="#build">Build</a></h3>
<pre><code class="language-shell">$ forge build
</code></pre>
<h3 id="test"><a class="header" href="#test">Test</a></h3>
<p>Simulate the exploits (and verify the traps trigger):</p>
<pre><code class="language-shell">$ forge test
</code></pre>
<h3 id="deploy-local-anvil"><a class="header" href="#deploy-local-anvil">Deploy (Local Anvil)</a></h3>
<pre><code class="language-shell">$ anvil
$ forge script script/DeployTraps.s.sol --rpc-url localhost
</code></pre>
<hr />
<p><em>Stay safe, stay paranoid.</em></p>
<h1 id="the-trapper"><a class="header" href="#the-trapper">the-trapper</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contents"><a class="header" href="#contents">Contents</a></h1>
<ul>
<li><a href="src/traps/AntiMEV.sol/contract.AntiMEV.html">AntiMEV</a></li>
<li><a href="src/traps/ReentrancyBait.sol/contract.ReentrancyBait.html">ReentrancyBait</a></li>
<li><a href="src/traps/StorageGhost.sol/contract.StorageGhost.html">StorageGhost</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="antimev"><a class="header" href="#antimev">AntiMEV</a></h1>
<p><a href="https://github.com/smallyunet/the-trapper/blob/92e3a58fe80d77986dadac7703649c3cd77971ad/src/traps/AntiMEV.sol">Git Source</a></p>
<p><strong>Title:</strong>
AntiMEV</p>
<p><strong>Author:</strong>
The-Trapper (Red Team)</p>
<p>TRAP EXPLANATION:
This contract detects common simulation and MEV bot behaviors.
THE BAIT:</p>
<ul>
<li>A function <code>flashArb</code> that looks like a highly profitable arbitrage opportunity.</li>
<li>It checks a visible "profit" condition that seems always true.
THE TRAP:</li>
<li>It checks <code>tx.gasprice</code> or block properties to detect if it's being simulated
or if it's being included in a bundle with high gas price (frontrunning).</li>
<li>If detected, it performs a "Silent Fail" or a "Gas Bomb".</li>
<li>NOTE: <code>cobinbase</code> check is a classic way to detect if block builder is the destination,
but here we'll use a <code>gasleft()</code> check or similar heuristic.</li>
</ul>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="secret_threshold"><a class="header" href="#secret_threshold">SECRET_THRESHOLD</a></h3>
<pre><code class="language-solidity">uint256 public constant SECRET_THRESHOLD = 50 gwei
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="receive"><a class="header" href="#receive">receive</a></h3>
<pre><code class="language-solidity">receive() external payable;
</code></pre>
<h3 id="claimprofit"><a class="header" href="#claimprofit">claimProfit</a></h3>
<p>Looks like a free money button.
Attacker calls this thinking they can drain the contract.</p>
<pre><code class="language-solidity">function claimProfit() external;
</code></pre>
<h3 id="_activatetrap"><a class="header" href="#_activatetrap">_activateTrap</a></h3>
<pre><code class="language-solidity">function _activateTrap() private;
</code></pre>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="arbitrageopportunity"><a class="header" href="#arbitrageopportunity">ArbitrageOpportunity</a></h3>
<pre><code class="language-solidity">event ArbitrageOpportunity(uint256 expectedProfit);
</code></pre>
<h3 id="gotcha"><a class="header" href="#gotcha">Gotcha</a></h3>
<pre><code class="language-solidity">event Gotcha(address indexed bot);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reentrancybait"><a class="header" href="#reentrancybait">ReentrancyBait</a></h1>
<p><a href="https://github.com/smallyunet/the-trapper/blob/92e3a58fe80d77986dadac7703649c3cd77971ad/src/traps/ReentrancyBait.sol">Git Source</a></p>
<p><strong>Title:</strong>
ReentrancyBait</p>
<p><strong>Author:</strong>
The-Trapper (Red Team)</p>
<p>TRAP EXPLANATION:
This contract exposes a classic reentrancy vulnerability.
THE BAIT:</p>
<ul>
<li>A <code>withdraw</code> function that sends ETH <em>before</em> updating the balance.</li>
<li>This violates Checks-Effects-Interactions pattern.
THE TRAP:</li>
<li>We use a secondary variable <code>_locked</code> or <code>gas</code> check that acts as a mutex
BUT it's hidden or implemented in a way that allows the FIRST reentry but fails deeply
nested ones, or traps the funds by updating a different state on reentry.</li>
<li>Actually, a fun trap is: The reentrancy allows you to "double spend" but the
<code>transfer</code> uses a limited amount of gas that is enough for a wallet receive
but NOT enough for the complex fallback logic of the attacker.</li>
<li>OR: We update a shadow balance in the reentrancy that results in 0 payout globally.</li>
</ul>
<h2 id="state-variables-1"><a class="header" href="#state-variables-1">State Variables</a></h2>
<h3 id="balances"><a class="header" href="#balances">balances</a></h3>
<pre><code class="language-solidity">mapping(address =&gt; uint256) public balances
</code></pre>
<h3 id="_shadowlock"><a class="header" href="#_shadowlock">_shadowLock</a></h3>
<pre><code class="language-solidity">bool private _shadowLock
</code></pre>
<h2 id="functions-1"><a class="header" href="#functions-1">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<pre><code class="language-solidity">constructor() payable;
</code></pre>
<h3 id="deposit"><a class="header" href="#deposit">deposit</a></h3>
<pre><code class="language-solidity">function deposit() external payable;
</code></pre>
<h3 id="withdraw"><a class="header" href="#withdraw">withdraw</a></h3>
<p>The Vulnerable Function.
Attacker sees: call(value) BEFORE balances[msg.sender] = 0.</p>
<pre><code class="language-solidity">function withdraw() external;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="storageghost"><a class="header" href="#storageghost">StorageGhost</a></h1>
<p><a href="https://github.com/smallyunet/the-trapper/blob/92e3a58fe80d77986dadac7703649c3cd77971ad/src/traps/StorageGhost.sol">Git Source</a></p>
<p><strong>Title:</strong>
StorageGhost</p>
<p><strong>Author:</strong>
The-Trapper (Red Team)</p>
<p>TRAP EXPLANATION:
This contract appears to be a standard Proxy/Implementation pattern where
the owner can update the implementation.
THE BAIT:</p>
<ul>
<li>A <code>delegatecall</code> to an implementation address that seems to allow overwriting the <code>owner</code>.</li>
<li>The attacker sees <code>owner</code> at slot 0 and <code>implementation</code> at slot 1 in the main contract.</li>
<li>The attacker provides a malicious implementation that writes their address to slot 0.
THE TRAP:</li>
<li>We use unstructured storage or a subtle inline assembly shift.</li>
<li>In this specific example, the <code>owner</code> is NOT at slot 0 despite the declaration order
suggesting it might be alignable.</li>
<li>Actually, we define a different storage layout or use a collision that writes to a
"trap" slot which locks the contract or burns gas, while the real processing happens elsewhere.
For this simple v1:
The <code>owner</code> variable is actually shadowed or the layout is messed up by inheritance
or we use EIP-1967 style slots but mislead the attacker about which one is active.
Let's make it simpler but effective:
The "Bait" contract uses <code>delegatecall</code> to <code>lib</code>. <code>lib</code> has <code>owner</code> at slot 0.
The "Ghost" contract has a hidden variable at slot 0 that triggers a LOCK when modified.</li>
</ul>
<h2 id="state-variables-2"><a class="header" href="#state-variables-2">State Variables</a></h2>
<h3 id="trapslot"><a class="header" href="#trapslot">trapSlot</a></h3>
<pre><code class="language-solidity">uint256 private trapSlot
</code></pre>
<h3 id="_owner_slot"><a class="header" href="#_owner_slot">_OWNER_SLOT</a></h3>
<pre><code class="language-solidity">bytes32 internal constant _OWNER_SLOT = keccak256("storage.ghost.owner")
</code></pre>
<h2 id="functions-2"><a class="header" href="#functions-2">Functions</a></h2>
<h3 id="onlyowner"><a class="header" href="#onlyowner">onlyOwner</a></h3>
<pre><code class="language-solidity">modifier onlyOwner() ;
</code></pre>
<h3 id="constructor-1"><a class="header" href="#constructor-1">constructor</a></h3>
<pre><code class="language-solidity">constructor() ;
</code></pre>
<h3 id="_getowner"><a class="header" href="#_getowner">_getOwner</a></h3>
<pre><code class="language-solidity">function _getOwner() internal view returns (address owner);
</code></pre>
<h3 id="_setowner"><a class="header" href="#_setowner">_setOwner</a></h3>
<pre><code class="language-solidity">function _setOwner(address newOwner) internal;
</code></pre>
<h3 id="execute"><a class="header" href="#execute">execute</a></h3>
<pre><code class="language-solidity">function execute(address target, bytes calldata data) external payable;
</code></pre>
<h3 id="withdraw-1"><a class="header" href="#withdraw-1">withdraw</a></h3>
<pre><code class="language-solidity">function withdraw() external onlyOwner;
</code></pre>
<h3 id="receive-1"><a class="header" href="#receive-1">receive</a></h3>
<pre><code class="language-solidity">receive() external payable;
</code></pre>
<h2 id="events-1"><a class="header" href="#events-1">Events</a></h2>
<h3 id="ownershiptransferred"><a class="header" href="#ownershiptransferred">OwnershipTransferred</a></h3>
<pre><code class="language-solidity">event OwnershipTransferred(address indexed oldOwner, address indexed newOwner);
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="solidity.min.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>


    </div>
    </body>
</html>
